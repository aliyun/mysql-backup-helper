package i18n

import (
	"os"
	"strings"

	"github.com/gioco-play/easy-i18n/i18n"
	"github.com/jeandeaual/go-locale"
	"golang.org/x/text/language"
	"golang.org/x/text/message"
)

// InitAuto initializes i18n, registers all translations, and sets the language based on system locale or LANG env.
func InitAuto() {
	// Register all translations
	registerTranslations()

	// Detect system locale
	userLocales, _ := locale.GetLocales()
	lang := language.English
	if len(userLocales) > 0 && strings.HasSuffix(strings.ToUpper(userLocales[0]), "CN") {
		lang = language.SimplifiedChinese
	} else if strings.Contains(os.Getenv("LANG"), "zh_CN") || strings.Contains(os.Getenv("LC_ALL"), "zh_CN") {
		lang = language.SimplifiedChinese
	}
	message.SetString(lang, "Current locale: %s\n", "Current locale: %s\n")
	message.SetString(language.English, "Current locale: %s\n", "Current locale: %s\n")
	// Set the language for i18n
	i18n.SetLang(lang)
}

// registerTranslations registers all English and Chinese translations
func registerTranslations() {
	// English section
	message.SetString(language.English, "Current locale: %s\n", "Current locale: %s\n")
	message.SetString(language.English, "Checking MySQL Server Version...", "Checking MySQL Server Version...")
	message.SetString(language.English, "Version", "Version")
	message.SetString(language.English, "maybe incompatible", "maybe incompatible")
	message.SetString(language.English, "Your MySQL Server version may newer than version that provided On Alibaba Cloud, data file probably incompatible, read doc online for more info.", "Your MySQL Server version may newer than version that provided On Alibaba Cloud, data file probably incompatible, read doc online for more info.")
	message.SetString(language.English, "Parameter", "Parameter")
	message.SetString(language.English, "Multiple parameters are not supported", "Multiple parameters are not supported")
	message.SetString(language.English, "Recommended parameter: ibdata1", "Recommended parameter: ibdata1")
	message.SetString(language.English, "Checking backup related parameters...\n", "Checking backup related parameters...\n")
	message.SetString(language.English, "Backup related parameters checked...\n", "Backup related parameters checked...\n")
	message.SetString(language.English, "Checking replication parameters (these parameters affect master-slave replication, but do not affect backup) ...\n", "Checking replication parameters (these parameters affect master-slave replication, but do not affect backup) ...\n")
	message.SetString(language.English, "Recommended parameter: %s", "Recommended parameter: %s")
	message.SetString(language.English, "Replication parameter check completed", "Replication parameter check completed")
	message.SetString(language.English, "Parameter not set", "Parameter not set")
	message.SetString(language.English, "Get parameter for checking...\n", "Get parameter for checking...\n")
	message.SetString(language.English, "Parsing file: %s", "Parsing file: %s")
	message.SetString(language.English, "Transfer Started, ConsumedBytes: %d, TotalBytes %d.\n", "Transfer Started, ConsumedBytes: %d, TotalBytes %d.\n")
	message.SetString(language.English, "\rTransfer Data, ConsumedBytes: %d, TotalBytes %d, %d%%.", "\rTransfer Data, ConsumedBytes: %d, TotalBytes %d, %d%%.")
	message.SetString(language.English, "\nTransfer Completed, ConsumedBytes: %d, TotalBytes %d.\n", "\nTransfer Completed, ConsumedBytes: %d, TotalBytes %d.\n")
	message.SetString(language.English, "\nTransfer Failed, ConsumedBytes: %d, TotalBytes %d.\n", "\nTransfer Failed, ConsumedBytes: %d, TotalBytes %d.\n")
	message.SetString(language.English, "Please input mysql-server password: ", "Please input mysql-server password: ")
	message.SetString(language.English, "connect to mysql-server host=%s port=%d user=%s\n", "connect to mysql-server host=%s port=%d user=%s\n")
	message.SetString(language.English, "Equivalent shell command: %s\n", "Equivalent shell command: %s\n")
	message.SetString(language.English, "You can check the backup log file for details: %s\n", "You can check the backup log file for details: %s\n")
	message.SetString(language.English, "Load config error: %v\n", "Load config error: %v\n")
	message.SetString(language.English, "OSS upload error: %v\n", "OSS upload error: %v\n")
	message.SetString(language.English, "You must specify --stream-port when mode=stream\n", "You must specify --stream-port when mode=stream\n")
	message.SetString(language.English, "Stream server error: %v\n", "Stream server error: %v\n")
	message.SetString(language.English, "TCP stream error: %v\n", "TCP stream error: %v\n")
	message.SetString(language.English, "Unknown mode: %s\n", "Unknown mode: %s\n")
	message.SetString(language.English, "Run xtrabackup error: %v\n", "Run xtrabackup error: %v\n")
	message.SetString(language.English, "Backup log read error.\n", "Backup log read error.\n")
	message.SetString(language.English, "Backup failed (no 'completed OK!').\n", "Backup failed (no 'completed OK!').\n")
	message.SetString(language.English, "zstd command not found. Please install zstd: https://github.com/facebook/zstd", "zstd command not found. Please install zstd: https://github.com/facebook/zstd")
	message.SetString(language.English, "AI diagnosis failed: %v\n", "AI diagnosis failed: %v\n")
	message.SetString(language.English, "AI diagnosis suggestion:\n", "AI diagnosis suggestion:\n")
	message.SetString(language.English, "Would you like to use AI diagnosis? (y/n): ", "Would you like to use AI diagnosis? (y/n): ")
	message.SetString(language.English, "Qwen API Key is required for AI diagnosis. Please set it in config.\n", "Qwen API Key is required for AI diagnosis. Please set it in config.\n")
	message.SetString(language.English, "AI diagnosis on backup failure: on/off. If not set, prompt interactively.", "AI diagnosis on backup failure: on/off. If not set, prompt interactively.")
	message.SetString(language.English, "AI_DIAG_PROMPT", "You are a MySQL backup expert. Based on the provided log error information, give concise and clear repair suggestions in English. The output should be suitable for display in the command line, avoid using Markdown format, and use a clear text structure.\n\nSample output format:\nERROR: [Error keyword]\nCAUSE: [Brief analysis of the cause]\nFIX: [Specific repair steps]")
	message.SetString(language.English, "Enable handshake for TCP streaming (default: false, can be set in config)", "Enable handshake for TCP streaming (default: false, can be set in config)")
	message.SetString(language.English, "Handshake key for TCP streaming (default: empty, can be set in config)", "Handshake key for TCP streaming (default: empty, can be set in config)")
	message.SetString(language.English, "Path to existing xtrabackup backup file to upload (use '-' for stdin)", "Path to existing xtrabackup backup file to upload (use '-' for stdin)")
	message.SetString(language.English, "Processing existing backup file...", "Processing existing backup file...")
	message.SetString(language.English, "Reading backup data from stdin...", "Reading backup data from stdin...")
	message.SetString(language.English, "Reading backup data from file: %s", "Reading backup data from file: %s")
	message.SetString(language.English, "Open backup file error: %v", "Open backup file error: %v")
	message.SetString(language.English, "Uploading existing backup to OSS...", "Uploading existing backup to OSS...")
	message.SetString(language.English, "OSS upload completed!", "OSS upload completed!")
	message.SetString(language.English, "Starting TCP stream server on port %d...", "Starting TCP stream server on port %d...")
	message.SetString(language.English, "Equivalent command: cat %s | nc -l4 %d", "Equivalent command: cat %s | nc -l4 %d")
	message.SetString(language.English, "Streaming backup data...", "Streaming backup data...")
	message.SetString(language.English, "Stream completed!", "Stream completed!")
	message.SetString(language.English, "Validating backup file: %s", "Validating backup file: %s")
	message.SetString(language.English, "Valid xbstream backup file detected", "Valid xbstream backup file detected")
	message.SetString(language.English, "Invalid backup file", "Invalid backup file")
	message.SetString(language.English, "Error: %s", "Error: %s")
	message.SetString(language.English, "File does not exist: %s", "File does not exist: %s")
	message.SetString(language.English, "Cannot open file: %v", "Cannot open file: %v")
	message.SetString(language.English, "Invalid xbstream backup file format", "Invalid xbstream backup file format")
	message.SetString(language.English, "Validating backup data from stdin...", "Validating backup data from stdin...")
	message.SetString(language.English, "Valid xbstream backup data detected", "Valid xbstream backup data detected")
	message.SetString(language.English, "Invalid backup data", "Invalid backup data")
	message.SetString(language.English, "Validation error: %v", "Validation error: %v")
	message.SetString(language.English, "Cannot proceed with invalid backup file.", "Cannot proceed with invalid backup file.")
	message.SetString(language.English, "Skipping validation for stdin to avoid data consumption", "Skipping validation for stdin to avoid data consumption")
	message.SetString(language.English, "Please ensure the stdin data is valid xbstream format", "Please ensure the stdin data is valid xbstream format")

	// Chinese section
	message.SetString(language.SimplifiedChinese, "Current locale: %s\n", "当前语言环境: %s\n")
	message.SetString(language.SimplifiedChinese, "Checking MySQL Server Version...", "检查MySQL版本...")
	message.SetString(language.SimplifiedChinese, "Version", "版本")
	message.SetString(language.SimplifiedChinese, "maybe incompatible", "可能无法兼容")
	message.SetString(language.SimplifiedChinese, "Your MySQL Server version may newer than version that provided On Alibaba Cloud, data file probably incompatible, read doc online for more info.", "您需要通过物理备份迁移到云上的数据库小版本较高，云上MySQL可能无法兼容该版本的数据文件，可在MySQL全量备份上云帮助文档页面确认")
	message.SetString(language.SimplifiedChinese, "Parameter", "参数")
	message.SetString(language.SimplifiedChinese, "Multiple parameters are not supported", "不支持多参数")
	message.SetString(language.SimplifiedChinese, "Recommended parameter: ibdata1", "建议参数: ibdata1")
	message.SetString(language.SimplifiedChinese, "Checking backup related parameters...\n", "检查备份相关参数...\n")
	message.SetString(language.SimplifiedChinese, "Backup related parameters checked...\n", "备份相关参数检查完毕...\n")
	message.SetString(language.SimplifiedChinese, "Checking replication parameters (these parameters affect master-slave replication, but do not affect backup) ...\n", "检查复制参数中(以下参数影响主备复制, 并不影响备份)...\n")
	message.SetString(language.SimplifiedChinese, "Recommended parameter: %s", "建议参数: %s")
	message.SetString(language.SimplifiedChinese, "Replication parameter check completed", "复制参数检查完毕")
	message.SetString(language.SimplifiedChinese, "Parameter not set", "参数未设置")
	message.SetString(language.SimplifiedChinese, "Get parameter for checking...\n", "获取参数中...\n")
	message.SetString(language.SimplifiedChinese, "Parsing file: %s", "解析文件:%s")
	message.SetString(language.SimplifiedChinese, "Transfer Started, ConsumedBytes: %d, TotalBytes %d.\n", "开始传输，已消耗字节: %d, 总字节: %d.\n")
	message.SetString(language.SimplifiedChinese, "\rTransfer Data, ConsumedBytes: %d, TotalBytes %d, %d%%.", "\r传输数据，已消耗字节: %d, 总字节: %d, %d%%.")
	message.SetString(language.SimplifiedChinese, "\nTransfer Completed, ConsumedBytes: %d, TotalBytes %d.\n", "\n传输完成，已消耗字节: %d, 总字节: %d.\n")
	message.SetString(language.SimplifiedChinese, "\nTransfer Failed, ConsumedBytes: %d, TotalBytes %d.\n", "\n传输失败，已消耗字节: %d, 总字节: %d.\n")
	message.SetString(language.SimplifiedChinese, "Please input mysql-server password: ", "请输入数据库密码: ")
	message.SetString(language.SimplifiedChinese, "connect to mysql-server host=%s port=%d user=%s\n", "连接数据库host=%s port=%d user=%s\n")
	message.SetString(language.SimplifiedChinese, "Equivalent shell command: %s\n", "等价 shell 命令: %s\n")
	message.SetString(language.SimplifiedChinese, "You can check the backup log file for details: %s\n", "你可以查看本地日志文件获取详细信息: %s\n")
	message.SetString(language.SimplifiedChinese, "Load config error: %v\n", "加载配置错误: %v\n")
	message.SetString(language.SimplifiedChinese, "OSS upload error: %v\n", "OSS上传错误: %v\n")
	message.SetString(language.SimplifiedChinese, "You must specify --stream-port when mode=stream\n", "mode=stream时必须指定--stream-port\n")
	message.SetString(language.SimplifiedChinese, "Stream server error: %v\n", "流服务错误: %v\n")
	message.SetString(language.SimplifiedChinese, "TCP stream error: %v\n", "TCP流错误: %v\n")
	message.SetString(language.SimplifiedChinese, "Unknown mode: %s\n", "未知模式: %s\n")
	message.SetString(language.SimplifiedChinese, "Run xtrabackup error: %v\n", "运行xtrabackup错误: %v\n")
	message.SetString(language.SimplifiedChinese, "Backup log read error.\n", "备份日志读取错误。\n")
	message.SetString(language.SimplifiedChinese, "Backup failed (no 'completed OK!').\n", "备份失败（未检测到 'completed OK!'）。\n")
	message.SetString(language.SimplifiedChinese, "zstd command not found. Please install zstd: https://github.com/facebook/zstd", "未找到zstd命令。请安装zstd: https://github.com/facebook/zstd")
	message.SetString(language.SimplifiedChinese, "AI diagnosis failed: %v\n", "AI诊断失败: %v\n")
	message.SetString(language.SimplifiedChinese, "AI diagnosis suggestion:\n", "AI诊断建议:\n")
	message.SetString(language.SimplifiedChinese, "Would you like to use AI diagnosis? (y/n): ", "是否使用AI诊断？(y/n): ")
	message.SetString(language.SimplifiedChinese, "Qwen API Key is required for AI diagnosis. Please set it in config.\n", "AI诊断需要 Qwen API Key，请在配置文件中设置。\n")
	message.SetString(language.SimplifiedChinese, "AI diagnosis on backup failure: on/off. If not set, prompt interactively.", "备份失败时AI诊断：on/off。不设置则交互式询问。")
	message.SetString(language.SimplifiedChinese, "AI_DIAG_PROMPT", "你是MySQL备份专家。请根据提供的日志错误信息，给出简洁、明确的中文修复建议。输出内容应适合在命令行中展示，避免使用Markdown格式，使用清晰的文本结构。\n\n示例输出格式：\n错误: [错误关键词]\n原因: [简要分析原因]\n修复: [具体修复步骤]")
	message.SetString(language.SimplifiedChinese, "Enable handshake for TCP streaming (default: false, can be set in config)", "TCP流推送启用握手认证（默认false，可在配置文件设置）")
	message.SetString(language.SimplifiedChinese, "Handshake key for TCP streaming (default: empty, can be set in config)", "TCP流推送握手密钥（默认空，可在配置文件设置）")
	message.SetString(language.SimplifiedChinese, "Path to existing xtrabackup backup file to upload (use '-' for stdin)", "已存在的xtrabackup备份文件路径，用于上传（使用'-'表示从stdin读取）")
	message.SetString(language.SimplifiedChinese, "Processing existing backup file...", "正在处理已存在的备份文件...")
	message.SetString(language.SimplifiedChinese, "Reading backup data from stdin...", "正在从标准输入读取备份数据...")
	message.SetString(language.SimplifiedChinese, "Reading backup data from file: %s", "正在从文件读取备份数据: %s")
	message.SetString(language.SimplifiedChinese, "Open backup file error: %v", "打开备份文件错误: %v")
	message.SetString(language.SimplifiedChinese, "Uploading existing backup to OSS...", "正在将已存在的备份上传到OSS...")
	message.SetString(language.SimplifiedChinese, "OSS upload completed!", "OSS上传完成！")
	message.SetString(language.SimplifiedChinese, "Starting TCP stream server on port %d...", "正在启动端口%d的TCP流服务器...")
	message.SetString(language.SimplifiedChinese, "Equivalent command: cat %s | nc -l4 %d", "等价命令: cat %s | nc -l4 %d")
	message.SetString(language.SimplifiedChinese, "Streaming backup data...", "正在流式传输备份数据...")
	message.SetString(language.SimplifiedChinese, "Stream completed!", "流式传输完成！")
	message.SetString(language.SimplifiedChinese, "Validating backup file: %s", "正在校验备份文件: %s")
	message.SetString(language.SimplifiedChinese, "Valid xbstream backup file detected", "检测到有效的xbstream备份文件")
	message.SetString(language.SimplifiedChinese, "Invalid backup file", "无效的备份文件")
	message.SetString(language.SimplifiedChinese, "Error: %s", "错误: %s")
	message.SetString(language.SimplifiedChinese, "File does not exist: %s", "文件不存在: %s")
	message.SetString(language.SimplifiedChinese, "Cannot open file: %v", "无法打开文件: %v")
	message.SetString(language.SimplifiedChinese, "Invalid xbstream backup file format", "无效的xbstream备份文件格式")
	message.SetString(language.SimplifiedChinese, "Validating backup data from stdin...", "正在校验从标准输入读取的备份数据...")
	message.SetString(language.SimplifiedChinese, "Valid xbstream backup data detected", "检测到有效的xbstream备份数据")
	message.SetString(language.SimplifiedChinese, "Invalid backup data", "无效的备份数据")
	message.SetString(language.SimplifiedChinese, "Validation error: %v", "校验错误: %v")
	message.SetString(language.SimplifiedChinese, "Cannot proceed with invalid backup file.", "无法处理无效的备份文件。")
	message.SetString(language.SimplifiedChinese, "Skipping validation for stdin to avoid data consumption", "跳过stdin校验以避免数据丢失")
	message.SetString(language.SimplifiedChinese, "Please ensure the stdin data is valid xbstream format", "请确保stdin数据是有效的xbstream格式")
}
